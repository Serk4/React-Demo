name: Daily Database Reset

on:
  schedule:
    # Run at 2:00 AM UTC daily (adjust timezone as needed)
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual trigger for testing
    inputs:
      environment:
        description: 'Environment to reset (preview, production, or all)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - preview
          - production
      verbose:
        description: 'Enable verbose logging'
        required: false
        default: false
        type: boolean

jobs:
  database-reset:
    name: Database Reset
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Run Unified Database Reset
        run: |
          cd server
          ENV="${{ github.event.inputs.environment || 'all' }}"
          VERBOSE_FLAG=""

          if [[ "${{ github.event.inputs.verbose }}" == "true" ]]; then
            VERBOSE_FLAG="--verbose"
          fi

          echo "üöÄ Running database reset for environment: $ENV"
          node scripts/unified-database-reset.js $ENV $VERBOSE_FLAG
        env:
          NODE_ENV: production

  notify-results:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [database-reset]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "üìä Daily Database Reset Complete"
          echo "Status: ${{ needs.database-reset.result }}"
          echo "Time: $(date -u)"

          if [[ "${{ needs.database-reset.result }}" == "success" ]]; then
            echo "‚úÖ All database resets completed successfully"
          else
            echo "‚ö†Ô∏è Some database resets may have failed - check logs above"
            echo "üí° This is normal if production API is not deployed or in memory mode"
          fi

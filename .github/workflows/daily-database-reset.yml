name: Daily Database Reset

on:
  schedule:
    # Run at 2:00 AM UTC daily (adjust timezone as needed)
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual trigger for testing

jobs:
  reset-preview:
    name: Reset Preview Database
    runs-on: ubuntu-latest
    steps:
      - name: Reset Preview Database
        run: |
          echo "üîÑ Resetting Preview database..."
          # Try the preview URL with proper error handling
          RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" -X POST "https://react-demo-preview.vercel.app/api/admin/reset" \
            -H "Content-Type: application/json")
          HTTP_CODE=$(echo $RESPONSE | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          BODY=$(echo $RESPONSE | sed -e 's/HTTPSTATUS\:.*//g')

          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            echo "‚úÖ Preview database reset successful!"
            echo "üìä Response: $BODY"
          else
            echo "‚ö†Ô∏è Preview reset returned HTTP $HTTP_CODE (database may be in memory mode)"
            echo "üìÑ Response: $BODY"
            # Don't fail the job for preview, as it might be in memory mode
          fi

  reset-production:
    name: Reset Production Database
    runs-on: ubuntu-latest
    needs: reset-preview
    steps:
      - name: Reset Production Database
        run: |
          echo "üîÑ Resetting Production database..."
          # Reset production database with proper error handling
          RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" -X POST "https://react-demo.vercel.app/api/admin/reset" \
            -H "Content-Type: application/json")
          HTTP_CODE=$(echo $RESPONSE | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          BODY=$(echo $RESPONSE | sed -e 's/HTTPSTATUS\:.*//g')

          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            echo "‚úÖ Production database reset successful!"
            echo "üìä Response: $BODY"
          else
            echo "‚ùå Production reset failed with HTTP $HTTP_CODE"
            echo "üìÑ Response: $BODY"
            exit 1  # Fail the job for production issues
          fi

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [reset-preview, reset-production]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "üìä Daily Database Reset Summary"
          echo "Preview: ${{ needs.reset-preview.result }}"
          echo "Production: ${{ needs.reset-production.result }}"
          echo ""
          echo "üí° Note: Production requires separate API backend deployment"

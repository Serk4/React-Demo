name: Daily Database Reset

on:
  schedule:
    # Run at 2:00 AM UTC daily (adjust timezone as needed)
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual trigger for testing

jobs:
  reset-preview:
    name: Reset Preview Database
    runs-on: ubuntu-latest
    steps:
      - name: Reset Preview Database
        run: |
          echo "üîÑ Resetting Preview database..."
          # Try the preview URL with proper error handling
          RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" -X POST "https://react-demo-preview.vercel.app/api/users/admin/reset" \
            -H "Content-Type: application/json")
          HTTP_CODE=$(echo $RESPONSE | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          BODY=$(echo $RESPONSE | sed -e 's/HTTPSTATUS\:.*//g')

          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            echo "‚úÖ Preview database reset successful!"
            echo "üìä Response: $BODY"
          else
            echo "‚ö†Ô∏è Preview reset returned HTTP $HTTP_CODE (database may be in memory mode)"
            echo "üìÑ Response: $BODY"
            # Don't fail the job for preview, as it might be in memory mode
          fi

  reset-production:
    name: Reset Production Database
    runs-on: ubuntu-latest
    needs: reset-preview
    steps:
      - name: Reset Production Database
        run: |
          echo "üîÑ Resetting Production database..."
          echo "üí° Note: Production API backend needs to be deployed as separate Vercel project"

          # Try possible production API URLs
          PRODUCTION_URLS=(
            "https://server-ljy4cbion-davids-projects-8b1113d6.vercel.app/api/users/admin/reset"
            "https://react-demo-server.vercel.app/api/users/admin/reset"
          )

          RESET_SUCCESS=false

          for URL in "${PRODUCTION_URLS[@]}"; do
            echo "üåê Trying: $URL"
            
            RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" -X POST "$URL" \
              -H "Content-Type: application/json" || echo "CURL_FAILED")
            
            if [[ "$RESPONSE" == "CURL_FAILED" ]]; then
              echo "   Network error - URL may not exist"
              continue
            fi
            
            HTTP_CODE=$(echo $RESPONSE | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
            BODY=$(echo $RESPONSE | sed -e 's/HTTPSTATUS\:.*//g')
            
            echo "   HTTP Code: $HTTP_CODE"
            
            if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
              echo "‚úÖ Production database reset successful!"
              echo "üìä Response: $BODY"
              RESET_SUCCESS=true
              break
            else
              echo "   Failed with HTTP $HTTP_CODE"
            fi
          done

          if [ "$RESET_SUCCESS" = false ]; then
            echo "‚ö†Ô∏è Production API backend not found at expected URLs"
            echo "üîß To enable production resets, deploy server/ folder to Vercel separately"
            echo "üìã Current setup: Frontend and API need separate deployments"
            # Don't exit 1 - this is expected until backend is deployed
          fi

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [reset-preview, reset-production]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "üìä Daily Database Reset Summary"
          echo "Preview: ${{ needs.reset-preview.result }}"
          echo "Production: ${{ needs.reset-production.result }}"
          echo ""
          echo "üí° Note: Production requires separate API backend deployment"
